<head>
  <meta charset="utf-8"></meta>
  <link rel="stylesheet" href="../src/bootstrap.min.css">
  <link rel="stylesheet" href="../src/main.css">
  <link rel="stylesheet" href="document.css">
  <link rel="stylesheet" href='../resource/font-awesome/css/font-awesome.min.css'>

  <!-- Insert this line above script imports  -->
  <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>

  <script src='../src/jquery-3.2.0.min.js'></script>
  <script src='../resource/html/snippet.js'></script>
  <script src='../src/global.js'></script>
  <script src='../src/draw.js'></script>
  <script src='../src/draw/axis.js'></script>
  <script src="../src/shim.js"></script>
  <script src="../src/jszip.js"></script>
  <script src="../src/xlsx/xlsx.full.min.cellStyles.js"></script>
  <script src="../src/ods.js"></script>
  <script src="../src/FileSaver.min.js"></script>
  <script src='../src/converter/tableToExcel.js'></script>
  <script src='../src/loadJS.js'></script>
  <script src='../src/bootstrap.min.js'></script>
  <script src='../src/addPanel.js'></script>
  <script src='../src/event.js'></script>
  <script src='../src/parser.0.1.3.js'></script>
  <script src='../src/MDF.0.9.js'></script>
  <script src='../src/json-viewer.js'></script>

  <!-- Insert this line after script imports -->
  <script>if (window.module) module = window.module;</script>
  <title>集成工作台</title>
  <style>
    #wrapper_document table{

    }

  </style>
</head>
<body>
  <div id='body-wrapper'>
    <script>document.write(snippet["toolbar"]);</script>
    <script src='../resource/html/toolbar.js'></script>

    <div id="workplace-root-wrapper">
      <!-- myPanel of file list -->
      <div style="display:flex">
        <left style="width:200pt; flex-shrink:0;">
          <panel id='panel_file_list'></panel>
          <panel id='panel_file_preview'></panel>
        </left>

        <middle-panel style="width: 635pt; display:flex; flex-direction:column;">
          <panel id='wrapper_document' style="display:flex; flex-direction:column;" role='document'></panel>
        </middle-panel>

        <right-panel style="flex: 1; display:flex; flex-direction:column;" >
          <div>
            <p>
              <script>document.write(`<button id="jleft">Left</button>`)</script>
              <button onclick='document.execCommand("justifycenter")'>Center</button>
              <button onclick='document.execCommand("justifyright")'>Right</button>
            </p>
            <p contenteditable="true">feeef</p>
          </div>
        </right-panel>
      </div>
    </div>
  </div>
</body>
<script>
  $global.document = {
      pageSetup: {
          type: "A4Compact",
          width: "595.4pt",
          headerPaddingTop: "42.5pt",
          footerPaddingBottom: "49.6pt",
          firstHeaderHeight: "102pt",
          firstFooterHeight: "128.9pt",
          firstPageHeight: "561.2pt",
          headerHeight: "",
      },
  };
  addPanel('panel_file_list', true, {
    title:"文件列表",
    body:snippet["panel_file_list_table_template"],
    bodyStyle: "height: 500px;overflow-y:scroll;",
  });
  addPanel('panel_file_preview', true, {
    title:"文件预览",
    bodyStyle: "height: 500px;overflow-y:scroll;"
  });
  addPanel('wrapper_document', true, {
    title:"document",
    bodyStyle: "width: 629pt; height: 900pt; overflow-y:auto;display:flex; flex-direction:column;",
  });


  //需要的样式
  document.write('<style>.cannotselect{-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;-khtml-user-select:none;user-select:none;}td.selected{background:#0094ff;color:#fff}</style>');
  //jQuery表格单元格合并插件，功能和excel单元格合并功能一样，并且可以保留合并后的所有单元格内容到第一个单元格中
  $.fn.tableMergeCells = function () {
      //***请保留原作者相关信息
      //***power by showbo,http://www.w3dev.cn
      return this.each(function () {
          var tb = $(this), startTD, endTD, MMRC = { startRowIndex: -1, endRowIndex: -1, startCellIndex: -1, endCellIndex: -1 };
          //初始化所有单元格的行列下标内容并存储到dom对象中
          tb.find('tr').each(function (r) { $('td', this).each(function (c) { $(this).data('rc', { r: r, c: c }); }) });
          //添加表格禁止选择样式和事件
          //tb.addClass('cannotselect').bind('selectstart', function () { return false });
          //选中单元格处理函数
          function addSelectedClass() {
              var selected = false,  rc,t;
              tb.find('td').each(function () {
                  rc = $(this).data('rc');
                  //判断单元格左上坐标是否在鼠标按下和移动到的单元格行列区间内
                  selected = rc.r >= MMRC.startRowIndex && rc.r <= MMRC.endRowIndex && rc.c >= MMRC.startCellIndex && rc.c <= MMRC.endCellIndex;
                  if (!selected && rc.maxc) {//合并过的单元格，判断另外3（左下，右上，右下）个角的行列是否在区域内
                      selected =
                          (rc.maxr >= MMRC.startRowIndex && rc.maxr <= MMRC.endRowIndex && rc.c >= MMRC.startCellIndex && rc.c <= MMRC.endCellIndex) ||//左下
                          (rc.r >= MMRC.startRowIndex && rc.r <= MMRC.endRowIndex && rc.maxc >= MMRC.startCellIndex && rc.maxc <= MMRC.endCellIndex) ||//右上
                          (rc.maxr >= MMRC.startRowIndex && rc.maxr <= MMRC.endRowIndex && rc.maxc >= MMRC.startCellIndex && rc.maxc <= MMRC.endCellIndex);//右下

                  }
                  if (selected)  this.className = 'selected';
              });
              var rangeChange = false;
              tb.find('td.selected').each(function () { //从已选中单元格中更新行列的开始结束下标
                  rc = $(this).data('rc');
                  t = MMRC.startRowIndex;
                  MMRC.startRowIndex = Math.min(MMRC.startRowIndex, rc.r);
                  rangeChange = rangeChange || MMRC.startRowIndex != t;

                  t = MMRC.endRowIndex;
                  MMRC.endRowIndex = Math.max(MMRC.endRowIndex, rc.maxr || rc.r);
                  rangeChange = rangeChange || MMRC.endRowIndex != t;

                  t = MMRC.startCellIndex;
                  MMRC.startCellIndex = Math.min(MMRC.startCellIndex, rc.c);
                  rangeChange = rangeChange || MMRC.startCellIndex != t;

                  t = MMRC.endCellIndex;
                  MMRC.endCellIndex = Math.max(MMRC.endCellIndex, rc.maxc || rc.c);
                  rangeChange = rangeChange || MMRC.endCellIndex != t;
              });
              //注意这里如果用代码选中过合并的单元格需要重新执行选中操作
              if (rangeChange) addSelectedClass();
          }
          function onMousemove(e) {//鼠标在表格单元格内移动事件
              e = e || window.event;
              var o = e.srcElement || e.target;
              if (o.tagName == 'TD') {
                  endTD = o;
                  var sRC = $(startTD).data('rc'), eRC = $(endTD).data('rc'), rc;
                  MMRC.startRowIndex = Math.min(sRC.r, eRC.r);
                  MMRC.startCellIndex = Math.min(sRC.c, eRC.c);
                  MMRC.endRowIndex = Math.max(sRC.r, eRC.r);
                  MMRC.endCellIndex = Math.max(sRC.c, eRC.c);
                  tb.find('td').removeClass('selected');
                  addSelectedClass();
              }
          }
          function onMouseup(e) {//鼠标弹起事件
              tb.unbind({ mouseup: onMouseup, mousemove: onMousemove });

              if (startTD && endTD && startTD != endTD && confirm('确认合并？！')) {//开始结束td不相同确认合并
                  var tds = tb.find('td.selected'), firstTD = tds.eq(0), index = -1, t, addBR
                      , html = tds.filter(':gt(0)').map(function () {
                      t = this.parentNode.rowIndex;
                      addBR = index != -1 && index != t;
                      index = t;
                      return (addBR ? '<br>' : '') + this.innerHTML
                  }).get().join(' ');
                  tds.filter(':gt(0)').remove(); firstTD.append(' ' + html.replace(/ (<br>)/g, '$1'));

                  //更新合并的第一个单元格的缓存rc数据为所跨列和行
                  var rc = firstTD.attr({ colspan: MMRC.endCellIndex - MMRC.startCellIndex + 1, rowspan: MMRC.endRowIndex - MMRC.startRowIndex + 1 }).data('rc');
                  rc.maxc = rc.c + MMRC.endCellIndex - MMRC.startCellIndex; rc.maxr = rc.r + MMRC.endRowIndex - MMRC.startRowIndex;

                  firstTD.data('rc', rc);

              }
              tb.find('td').removeClass('selected');
              startTD = endTD = null;
          }
          function onMousedown(e) {
              var o = e.target;
              if (o.tagName == 'TD') {
                  startTD = o;
                  tb.bind({ mouseup: onMouseup, mousemove: onMousemove });
              }
          }
          tb.mousedown(onMousedown);
      });
  };

</script>
